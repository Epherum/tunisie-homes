generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum DataSource {
  TUNISIE_ANNONCE
  MUBAWAB
  TAYARA
  USER_UPLOAD
}

enum ListingType {
  RENT
  SALE
}

enum PropertyStatus {
  ACTIVE
  SOLD
  RENTED
  INACTIVE
}

enum PropertyType {
  APARTMENT
  HOUSE
  STUDIO
  DUPLEX
  VILLA
  LAND
  PENTHOUSE
  COMMERCIAL
  OFFICE
  FARM
}

model Property {
  id                    String                @id @default(dbgenerated("gen_random_uuid()")) @db.Text
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  scrapedAt             DateTime              @default(now())
  analyzedAt            DateTime?
  title                 String
  description           String?
  listingType           ListingType
  price                 Float
  currency              String                @default("TND")
  pricePerSqm           Float?
  estimatedFairValue    Float?
  isPriceNegotiable     Boolean               @default(false)
  address               String?
  city                  String?
  region                String?
  latitude              Float?
  longitude             Float?
  location              Unsupported("geometry")?
  propertyType          PropertyType?
  surfaceArea           Float?
  rooms                 Int?
  bathrooms             Int?
  floor                 Int?
  totalFloors           Int?
  features              String[]             @default([])
  source                DataSource
  sourceUrl             String                @unique
  sourceId              String?
  status                PropertyStatus        @default(ACTIVE)
  renovationScore       Float?
  dealRating            Float?
  aiTags                String[]             @default([])
  aiDescription         String?
  descriptionEmbedding  Unsupported("vector")?
  views                 Int                   @default(0)
  isFeatured            Boolean               @default(false)
  contactPhone          String?
  contactEmail          String?
  contactName           String?

  images                Image[]
  priceHistory          PriceHistory[]
  analyses              AIAnalysis[]

  @@index([city, region], map: "properties_city_region_idx")
  @@index([createdAt], map: "properties_createdAt_idx")
  @@index([dealRating], map: "properties_dealRating_idx")
  @@index([latitude, longitude], map: "properties_latitude_longitude_idx")
  @@index([listingType], map: "properties_listingType_idx")
  @@index([price], map: "properties_price_idx")
  @@index([propertyType], map: "properties_propertyType_idx")
  @@index([rooms, bathrooms], map: "properties_rooms_bathrooms_idx")
  @@index([source], map: "properties_source_idx")
  @@index([status], map: "properties_status_idx")

  @@map("properties")
}

model Image {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Text
  url             String
  localPath       String?
  caption         String?
  order           Int          @default(0)
  width           Int?
  height          Int?
  analyzedAt      DateTime?
  aiTags          String[]       @default([])
  renovationScore Float?
  propertyId      String      @db.Text

  property        Property    @relation(fields: [propertyId], references: [id])

  @@index([propertyId], map: "images_propertyId_idx")
  @@map("images")
}

model PriceHistory {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Text
  price      Float
  recordedAt DateTime @default(now())
  source     String?
  propertyId String   @db.Text

  property   Property @relation(fields: [propertyId], references: [id])

  @@index([recordedAt, propertyId], map: "price_history_propertyId_recordedAt_idx")
  @@map("price_history")
}

model NeighborhoodStats {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Text
  updatedAt      DateTime @default(now())
  city           String
  region         String?
  avgPricePerSqm Float
  medianPrice    Float
  totalListings  Int
  activeListings Int
  avgRentPrice   Float?
  avgSalePrice   Float?

  @@unique([city, region], map: "neighborhood_stats_city_region_key")
  @@map("neighborhood_stats")
}

model AIAnalysis {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Text
  createdAt    DateTime  @default(now())
  modelUsed    String
  analysisType String
  result       Json
  confidence   Float?
  propertyId   String    @db.Text

  property     Property  @relation(fields: [propertyId], references: [id])

  @@index([analysisType], map: "ai_analyses_analysisType_idx")
  @@index([propertyId], map: "ai_analyses_propertyId_idx")
  @@map("ai_analyses")
}
